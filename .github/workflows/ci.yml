name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  linux:
    name: Build (Linux)
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: latest

      - name: Build and package
        run: earthly --ci --artifact +package/pawn-requests-linux.zip releases/pawn-requests-linux.zip

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawn-requests-linux
          path: releases/pawn-requests-linux.zip

  windows:
    name: Build (Windows)
    runs-on: windows-latest
    env:
      CONAN_VCVARS_VER: "14.4"
      VCVARS_VER: "14.4"
      VSCMD_ARG_VCVARS_VER: "14.4"

      CONAN_REQUEST_TIMEOUT: "600"
      CONAN_RETRIES: "5"
      CONAN_RETRY_WAIT: "10"
      CONAN_USER_HOME: ${{ github.workspace }}\.conan
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache Conan
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}\.conan
          key: windows-conan-${{ hashFiles('**/conanfile.*', '**/conan.lock', 'CMakeLists.txt', 'src/CMakeLists.txt', 'lib/cmake-conan/conan.cmake') }}
          restore-keys: |
            windows-conan-

      - name: Remove Conan download cache
        shell: pwsh
        run: |
          $conanHome = "${env:GITHUB_WORKSPACE}\.conan"
          $dataDir = Join-Path $conanHome "data"

          if (Test-Path $dataDir) {
            Write-Host "Purging all _dl folders under $dataDir (prevents corrupted partial downloads)"
            # cmd-based recursive deletion is often more reliable than pure PowerShell for deep trees
            cmd /c "for /d /r ""$dataDir"" %D in (_dl) do @echo Deleting %D & rmdir /s /q ""%D"""
          }

          # Belt-and-braces: ensure the known-problem file is gone if it exists
          $bad = Join-Path $conanHome "data\boost\1.83.0\_\_\dl\export\conan_sources.tgz"
          if (Test-Path $bad) {
            Write-Host "Deleting poisoned file: $bad"
            cmd /c "del /f /q ""$bad"""
          }

          if (Test-Path $bad) {
            throw "Still present after cleanup: $bad"
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Conan
        run: pip install "conan<2"

      - name: Configure Conan profile
        run: conan profile new default --detect --force

      - name: Force MSVC toolset
        run: conan profile update settings.compiler.version=194 default

      - name: Ensure MSVC v14.3 alias
        shell: pwsh
        run: |
          $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) { throw "vswhere.exe not found at $vswhere" }
          
          $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vsPath) {
            $vsPath = & $vswhere -latest -products * -property installationPath
          }
          if (-not $vsPath) { throw "Unable to locate Visual Studio installation via vswhere" }

          $toolsRoot = Join-Path $vsPath "VC\Tools\MSVC"
          $target = Get-ChildItem $toolsRoot | Sort-Object Name -Descending | Select-Object -First 1
          if (-not $target) { throw "Could not locate MSVC toolset under $toolsRoot" }
          
          $alias = Join-Path $toolsRoot "14.3"
          if (-not (Test-Path $alias)) {
            New-Item -ItemType Junction -Path $alias -Target $target.FullName | Out-Null
          }

      - name: Configure CMake
        run: cmake -S . -B build -A Win32 -DCMAKE_BUILD_TYPE=Release -T v143 -DCONAN_DISABLE_CHECK_COMPILER=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Package Windows artifact
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force releases -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path releases/windows/plugins -Force | Out-Null
          New-Item -ItemType Directory -Path releases/windows/includes -Force | Out-Null
          Copy-Item test/plugins/requests.dll releases/windows/plugins/requests.dll
          Copy-Item *.inc releases/windows/includes/
          Push-Location releases/windows
          Compress-Archive -Path plugins,includes -DestinationPath ../pawn-requests-windows.zip -Force
          Pop-Location

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawn-requests-windows
          path: releases/pawn-requests-windows.zip
