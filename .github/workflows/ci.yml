name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  linux:
    name: Build (Linux)
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Earthly
        uses: earthly/actions/setup-earthly@v1
        with:
          version: latest
      - name: Build and package
        run: earthly --ci --artifact +package/pawn-requests-linux.zip releases/pawn-requests-linux.zip
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawn-requests-linux
          path: releases/pawn-requests-linux.zip

  windows:
    name: Build (Windows)
    runs-on: windows-latest
    env:
      CONAN_VCVARS_VER: "14.4"
      VCVARS_VER: "14.4"
      VSCMD_ARG_VCVARS_VER: "14.4"
      CONAN_REQUEST_TIMEOUT: "600"
      CONAN_RETRY: "5"
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install Conan
        run: pip install "conan<2"
      - name: Configure Conan profile
        run: conan profile new default --detect --force
      - name: Force MSVC toolset
        run: conan profile update settings.compiler.version=194 default
      - name: Ensure MSVC v14.3 alias
        shell: pwsh
        run: |
          $toolsRoot = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio/2022/Enterprise/VC/Tools/MSVC"
          $target = Get-ChildItem $toolsRoot | Sort-Object Name -Descending | Select-Object -First 1
          if (-not $target) { throw "Could not locate MSVC toolset under $toolsRoot" }
          $alias = Join-Path $toolsRoot "14.3"
          if (-not (Test-Path $alias)) {
            New-Item -ItemType Junction -Path $alias -Target $target.FullName | Out-Null
          }
      - name: Configure CMake
        run: cmake -S . -B build -A Win32 -DCMAKE_BUILD_TYPE=Release -T v143 -DCONAN_DISABLE_CHECK_COMPILER=ON
      - name: Build
        run: cmake --build build --config Release
      - name: Package Windows artifact
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force releases -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path releases/windows/plugins -Force | Out-Null
          New-Item -ItemType Directory -Path releases/windows/includes -Force | Out-Null
          Copy-Item test/plugins/requests.dll releases/windows/plugins/requests.dll
          Copy-Item *.inc releases/windows/includes/
          Push-Location releases/windows
          Compress-Archive -Path plugins,includes -DestinationPath ../pawn-requests-windows.zip -Force
          Pop-Location
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawn-requests-windows
          path: releases/pawn-requests-windows.zip
